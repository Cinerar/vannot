const $=require("jquery"),{round,min,abs,sign,pow}=Math,{without,last,mean}=require("ramda"),{normalizeBox,datum,clamp}=require("../util");module.exports=(e,n,t)=>{const o=$(document),s={test:(e,{shape:n,point:t})=>!1,init:(e,{mouse:n})=>null,drag:(e,n)=>null,end:(e,{mouse:n})=>null},a=e=>Object.assign({},s,e),i=e=>Object.assign({},e,{init:(n,t)=>({inner:"function"==typeof e.init?e.init(n,t):null,last:t.mouse}),drag:({inner:n,last:t},o)=>({inner:e.drag(n,{dx:o.x-t.x,dy:o.y-t.y})||n,last:o}),end:({inner:n})=>{"function"==typeof e.end&&e.end(n)}}),l=a({name:"lassoing",test:e=>e.is("svg"),init:(e,{mouse:n})=>n,drag:(e,n)=>{t.setLasso(normalizeBox([e,n]))},end:()=>t.setLasso(null)}),c=a(i({name:"dragging",test:(e,{shape:n,point:o})=>null!=o&&t.selected.points.includes(o)||null!=n&&t.selected.wholeShapes.includes(n),init:(e,{keys:n})=>{n.duplicate&&0===t.selected.partialShapes.length&&t.duplicateSelected()},drag:(e,{dx:n,dy:o})=>{t.selected.points.forEach((e=>{e.x+=n,e.y+=o})),t.changedPoints()}})),d=a(i({name:"dragging",test:(e,{point:n})=>null!=t.selected.shape&&null!=n&&t.selected.shape.points.includes(n),init:e=>datum(e),drag:(e,{dx:n,dy:o})=>{e.x+=n,e.y+=o,t.changedPoints()}})),p=a(i({name:"dragging",test:e=>e.is(".implicitPoint"),init:e=>{const n=datum(e),o=t.selected.shape.points.indexOf(n.after);return t.selected.shape.points.splice(o+1,0,n.coords),t.changedPoints(),t.selectShape(t.selected.shape),n.coords},drag:(e,{dx:n,dy:o})=>{e.x+=n,e.y+=o,t.changedPoints()}})),r=a({test:()=>"pan"===t.tool,init:()=>{let e,n;o.on("mousemove.pan",(({pageX:o,pageY:s})=>{null!=e&&(t.pan={x:t.pan.x+(o-e),y:t.pan.y+(s-n)}),e=o,n=s}))},end:()=>{o.off("mousemove.pan")}}),u=(e,{shape:n,point:o,keys:s})=>{if(null!=o&&t.selected.points.includes(o))return!1;if(null!=n){const e=t.selected.wholeShapes.includes(n);return s.select?(t.selectedPoints=e?without(n.points,t.selected.points):t.selected.points.concat(n.points),!0):!e&&(t.selectShape(n),!0)}},h=(e,{point:n})=>{if(null!=n)return t.selectedPoints=[n],!0},g=e=>{if(e.is("svg"))return t.deselect(),!0},m={normal:[[u,g],[r,c,l]],drawing:[[r,e=>{if(e.is(".wipCloser"))return t.endShape(),!0},(e,{mouse:n})=>{t.wip.points.push(n),t.changedPoints()}]],shapes:[[u,g],[r,p,d,c,l]],points:[[u,g],[r,c,l]]},f={normal:[],drawing:[],shapes:[[h,(e,{shape:n,keys:o})=>{if(!o.select&&null!=n)return t.selectShape(n),!0}]],points:[[h]]};{let s,a,i;const l=e=>{const n=$(e.target),t=n.closest(".trackingShape"),o=t.length>0?datum(t):null,s=n.hasClass("shapePoint")?datum(n):null;return[n,o,s,{select:e.shiftKey,duplicate:e.ctrlKey||e.altKey}]},c=e.find(".vannot-viewport");c.on("mousedown",(e=>{a=t.state;const[n,o,d,p]=l(e),r={mouse:s,keys:p,shape:o,point:d};for(const e of m[t.state])e.some((e=>{if("function"==typeof e)return e(n,r);if(!0===e.test(n,r)){let o;return i=()=>{!0!==i.dragged&&(t.dragState=e.name,i.dragged=!0,o=e.init(n,r),c.one("mouseup",(()=>{t.dragState=null,e.end(o,s)}))),o=e.drag(o,s)||o},!0}}))})),c.on("mouseup",(e=>{const n=t.state;if(n===a&&(null==i||!0!==i.dragged)){const[t,o,a,i]=l(e),c={mouse:s,keys:i,shape:o,point:a};for(const e of f[n])e.some((e=>e(t,c)))}null!=i&&(i=null)})),o.on("keydown",(e=>{32===e.which&&(t.toolOverride="pan")})),o.on("keyup",(e=>{32===e.which&&(t.toolOverride=null)}));let d=0;o.on("keyup",(e=>{if($(e.target).is("input"))return;if(32!==e.which)return;const n=(new Date).getTime();n-d<300&&t.resetViewport(),d=n})),o.on("keydown",(e=>{68===e.which&&(e.ctrlKey||e.metaKey)&&(t.copyLast(),e.preventDefault())}));const p=e.find(".vannot-viewport video"),r=c.width()-p.width(),u=()=>{t.viewportSize={width:c.width(),height:c.height(),padding:r}};$(window).on("resize",u),u();const h=(e,n,t)=>({x:(e-r/2-t.origin.x)*t.factor,y:(n-r/2-t.origin.y)*t.factor}),g=(e,n)=>{t.mouse=s=h(e,n,t.projection),null!=i&&i(s)};o.on("mousemove",(({pageX:e,pageY:n})=>{g(e,n)}));const w=[],v=1.3,y=.1;let k;const x=e=>e>1?1:1===e?0:-1;let S;c.on("mousewheel",(e=>{const n=new Date;if(null!=k){const t=n-k.at;t>5&&t<500&&w.length<100&&w.push({deltaT:t,rate:abs(e.deltaY/t)})}k={at:n,deltaY:e.deltaY};const o=t.scale,a=w.length<2?y*sign(e.deltaY):e.deltaY*v/mean(w.map((e=>1e3*e.rate)))*pow(o,.7),i=clamp(.5,o+a,3.5),l=x(o),c=x(i);l===c||0===l&&null==S?t.scale=i:null==S?(t.scale=1,S={sign:l,at:n}):(c===S.sign||n-S.at>500)&&(t.scale=i,S=null);const d=h(e.pageX,e.pageY,t.projection);t.pan={x:t.pan.x+(d.x-s.x)/t.projection.factor,y:t.pan.y+(d.y-s.y)/t.projection.factor},g(e.pageX,e.pageY)}));const b=e.find(".vannot-video-zoom-edit");b.on("change",(e=>{t.scale=parseFloat(b.val()),b.blur()})),e.find(".vannot-reset-zoom").on("click",(()=>{t.resetViewport()})),e.find(".vannot-select-mode").on("click",(()=>{t.tool="select"})),e.find(".vannot-pan-mode").on("click",(()=>{t.tool="pan"})),e.find(".vannot-toolbar"),e.find(".vannot-copy-last").on("click",(()=>{n.pause(),t.copyLast()})),e.find(".vannot-draw-shape").on("click",(()=>{n.pause(),t.startShape(),t.tool="select"})),e.find(".vannot-undo-draw").on("click",(()=>{null!=t.wip.points.pop()&&t.changedPoints()})),e.find(".vannot-complete").on("click",(()=>t.endShape())),e.find(".vannot-object-select").on("change",(e=>{const n=parseInt($(e.target).find(":selected").attr("value"));if(!Number.isNaN(n)){for(const e of t.selected.wholeShapes)e.objectId=n;t.changedShapes()}})),e.find(".vannot-duplicate-shape").on("click",(()=>t.duplicateSelected(10))),e.find(".vannot-delete-shape").on("click",(()=>t.selected.wholeShapes.forEach((e=>t.removeShape(e))))),e.find(".vannot-instance-form").on("click",(()=>t.formInstance(t.selected.wholeShapes))),e.find(".vannot-instance-break").on("click",(()=>t.breakInstance(t.selected.wholeShapes))),e.find(".vannot-instance-select").on("click",(()=>t.selectInstance(t.selected.instances[0].id))),e.find(".vannot-instance-class").on("input",(e=>{document.activeElement===e.target&&t.setInstanceClass(t.selected.instance,e.target.value)})),e.find(".vannot-delete-points").on("click",(()=>t.removePoints(t.selected.points))),e.find(".vannot-expand-selection").on("click",(()=>t.expandSelection()))}};
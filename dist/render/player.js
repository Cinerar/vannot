const $=require("jquery"),{ceil}=Math,{sum}=require("ramda"),{select,scaleLinear}=require("d3"),{getTemplate,instantiateTemplates,instantiateDivs,pct,pad,timecode,timecodePretty,queuer}=require("../util"),drawTimecode=(e,t)=>{const a=timecode(e.frame,e.video.fps);t.select(".vannot-timecode-hh").text(pad(a.hh)),t.select(".vannot-timecode-mm").text(pad(a.mm)),t.select(".vannot-timecode-ss").text(pad(a.ss)),t.select(".vannot-timecode-fr").text(pad(a.frame))},minorThreshold=4,majorThreshold=80,tickScales=e=>[1,5,1*e,2*e,5*e,15*e,30*e,60*e,120*e,300*e,900*e,1800*e],generateTicks=([e,t],a,s)=>{const n=t-e,c=tickScales(a).find((e=>s/n*e>4)),l=ceil(e/c)*c;let r=c;for(;s/n*r<80;)r+=c;r<a&&(r=a);let i=l;const o=[];for(;i<t;)o.push({frame:i,major:i%r==0}),i+=c;return o},tickTemplate=getTemplate("tick"),drawTicks=(e,t)=>{const a=generateTicks(e.range,e.video.fps,t.node().clientWidth),s=instantiateTemplates(t.selectAll(".vannot-tick").data(a),tickTemplate);s.style("left",(t=>pct(e.scale(t.frame)))),s.classed("vannot-tick-major",(e=>e.major)),s.filter((e=>e.major)).select("span").text((t=>timecodePretty(t.frame,e.video.fps)))},drawPlayhead=(e,t)=>{const a=e.scale(e.frame),s=a>=0&&a<=100;t.classed("hide",!s),!0===s&&t.style("left",pct(a))},minThumb=100,drawRanger=(e,t)=>{const a=100/t.node().clientWidth/2,s=scaleLinear().domain([e.video.start,e.video.end]).range([a,1-a]),n=(e.range[1]-e.range[0])/2+e.range[0],c=s(n),l=scaleLinear().domain([e.video.start,n]).range([0,c-a])(e.range[0]),r=1-scaleLinear().domain([n,e.video.end]).range([c+a,1])(e.range[1]);t.select(".vannot-ranger-start").style("left",pct(l)),t.select(".vannot-ranger-fill").style("left",pct(l)),t.select(".vannot-ranger-fill").style("right",pct(r)),t.select(".vannot-ranger-end").style("right",pct(r))},trackTemplate=getTemplate("track"),drawTracks=(e,t,a,s)=>{const n=instantiateTemplates(s.selectAll(".vannot-track").data(t),trackTemplate);n.classed("system",(e=>e.system)),n.select(".vannot-track-title-edit").property("value",(e=>e.title)),n.select(".vannot-track-title-ghost").text((e=>e.title)),n.select(".vannot-track-color-edit").each((function(e){const t=$(this);0===t.next().length&&t.spectrum({color:e.color})})),n.select(".vannot-track-item-count").text((t=>null==t.segments?sum(e.data.frames.map((e=>e.shapes.filter((e=>e.objectId===t.id)).length))):t.segments.length)),n.select(".vannot-track-timeline").each(a)},drawTrackpoints=(e,t,a,s)=>{instantiateDivs(s.selectAll(".vannot-track-point").data(t),"vannot-track-point").style("left",(e=>pct(a.scale(e.frame)))).style("background-color",e.color)},subdrawTrackpoints=(e,t)=>function(a){const s=e.filter((e=>e.shapes.some((e=>e.objectId===a.id))));return drawTrackpoints(a,s,t,select(this))},segmentTemplate=getTemplate("track-segment"),drawTracklabels=(e,t,a)=>{instantiateTemplates(a.selectAll(".vannot-track-segment").data(e.segments),segmentTemplate).style("background-color",e.color).style("left",(e=>pct(t.scale(e.start)))).style("width",(e=>pct(t.scale(e.end)-t.scale(e.start)))),a.selectAll(".vannot-track-selection").classed("active",t.selection.target===e).style("left",pct(t.scale(t.selection.start))).style("width",pct(t.scale(t.selection.end)-t.scale(t.selection.start)))},subdrawTracklabels=e=>function(t){return drawTracklabels(t,e,select(this))},drawSegmentImplicits=(e,t)=>{t.selectAll(".vannot-track-segment").select(".vannot-track-segment-implicit").style("left",(t=>pct((e.frame-t.start)/(t.end-t.start))))},drawer=(e,t)=>{const a=e.select(".vannot-ticks"),s=e.select(".vannot-objects"),n=e.select(".vannot-labels"),c=e.select(".vannot-playhead"),l=e.select(".vannot-timecode"),r=e.select(".vannot-ranger"),i=(o=!1)=>{const d=i.dirty;i.dirty={},(o||d.playing)&&e.classed("playing",t.playing),(o||d.frame)&&drawTimecode(t,l),(o||d.range)&&(drawRanger(t,r),drawTicks(t,a)),(o||d.range||d.frame)&&drawPlayhead(t,c),(o||d.range||d.objects||d.shapes)&&drawTracks(t,t.data.objects,subdrawTrackpoints(t.data.frames,t),s),(o||d.range||d.labels||d.selection)&&drawTracks(t,t.data.labels,subdrawTracklabels(t),n),(o||d.labels||d.frame)&&drawSegmentImplicits(t,n)};return i.dirty={},i.all=()=>i(!0),i},reactor=(e,t,a)=>{const s=drawer(e,t),n=queuer(s),c=e=>()=>{n(),s.dirty[e]=!0};t.events.on("change.playing",c("playing")),t.events.on("change.range",c("range")),t.events.on("change.frame",c("frame")),t.events.on("change.objects",c("objects")),a.events.on("change.shapes",c("shapes")),t.events.on("change.labels",c("labels")),t.events.on("change.selection",c("selection")),s.all()};module.exports={reactor};
const{floor,ceil}=Math,EventEmitter=require("events"),{scaleLinear}=require("d3"),{defer,clamp,spliceOut}=require("../util");class VideoData{constructor(e){null!=e.pixelAspectRatio&&(e.pixelAspectRatio>1?e.width=floor(e.width*e.pixelAspectRatio):e.height=floor(e.height/e.pixelAspectRatio),delete e.pixelAspectRatio),Object.assign(this,e,{start:e.start||0,end:(e.start||0)+e.duration})}clamp(e){return clamp(this.start,e,this.end)}containsFrame(e){return this.start<=e&&e<=this.end}}class Player{constructor(e,t){this.data=t,this.video=new VideoData(t.video),this.videoObj=e[0],this.events=new EventEmitter,this.range=[this.video.start,this.video.end],this.frame=0,this.playing=!1,this.selection=null,this._initialize(e),this.seek(this.video.start)}_initialize(e){e.attr("src",this.video.source),e.on("playing",(()=>this.playing=!0)),e.on("pause",(()=>this.playing=!1));let t=0;e.on("timeupdate",(()=>{t=this.videoObj.currentTime,defer((()=>{this.frame=ceil(t*this.video.fps)}))}))}get playing(){return this._playing}set playing(e){e!==this._playing&&(!1===e&&(this.videoObj.currentTime=this.frame/this.video.fps),this._playing=e,this.events.emit("change.playing"))}get frame(){return this._frame}set frame(e){e!==this._frame&&(this._frame=e,this.events.emit("change.frame",this._frame),e>this.video.end&&this.seek(this.video.end))}get range(){return this._range}set range(e){this._range&&e[0]===this._range[0]&&e[1]===this._range[1]||(this._range=e,this.events.emit("change.range"))}get timelineWidth(){return this._timelineWidth}set timelineWidth(e){e!==this._timelineWidth&&(this._timelineWidth=e,this.events.emit("change.range"))}get selection(){return this._selection}set selection(e){this._selection=null==e?{target:null}:e,this.events.emit("change.selection")}changedObjects(){this.events.emit("change.objects")}changedLabels(){this.events.emit("change.labels")}get scale(){return scaleLinear().domain(this.range).range([0,1])}get prevFrame(){return this.data.frames.reduce(((e,t)=>t.frame<this.frame&&(null==e||t.frame>e.frame)?t:e),null)}get nextFrame(){return this.data.frames.reduce(((e,t)=>t.frame>this.frame&&(null==e||t.frame<e.frame)?t:e),null)}pause(){this.videoObj.pause()}play(){this.videoObj.play()}seek(e){this.pause(),this.frame=clamp(this.video.start,e,this.video.end),this.videoObj.currentTime=this.frame/this.video.fps}mergeSegments(){for(const e of this.data.labels){const t=e.segments,s=t.slice(0);for(;s.length>0;){const e=s.pop();for(const s of t)e!==s&&(s.start<=e.start&&e.end<=s.end?spliceOut(e,t):e.start<=s.start&&s.start<=e.end&&e.end<=s.end?(s.start=e.start,spliceOut(e,t)):s.start<=e.start&&e.start<=s.end&&s.end<=e.end&&(s.end=e.end,spliceOut(e,t)))}}this.changedLabels()}removeSelection(){const e=this.selection;if(null==e)return;const t=e.target.segments;for(const s of t)e.start<=s.start&&s.end<=e.end?spliceOut(s,t):s.start<e.start&&e.end<s.end?(t.push({start:e.end,end:s.end}),s.end=e.start):(s.start<e.start&&e.start<s.end&&(s.end=e.start),s.start<e.end&&e.end<s.end&&(s.start=e.end));this.selection=null,this.changedLabels()}}module.exports={Player};